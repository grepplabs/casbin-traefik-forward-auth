fullnameOverride: casbin-auth-rbac

image:
  repository: local/casbin-traefik-forward-auth
  tag: latest

serviceMonitor:
  enabled: true

application:
  env:
    LOG_FORMAT: "text"
    CASBIN_ADAPTER_KUBE_CONFIG_LABELS: "casbin.grepplabs.com/model=rbac"
  adapter:
    kube:
      namespace:
  authRouteConfig:
    routes:
      - httpMethod: POST
        relativePaths:
          - /v1alpha/publish
        params:
          - name: topicId
            source: header
            expr: Host
            function: firstLabel
          - name: projectId
            source: claim
            expr: acme/project/project\.id
          - name: sub
            source: claim
            expr: sub
          - name: iss
            source: claim
            expr: iss
        rules:
          - cases:
              - when: '!equals(iss, "acme/serviceaccount")'
                format: iam::%s:user/%s
                paramNames: [ projectId, sub ]
              - when: 'p["iss"] == "acme/serviceaccount"'
                format: iam::%s:sa/%s
                paramNames: [ projectId, sub ]
          - format: pubsub:eu-central-1:%s:topics/%s
            paramNames: [ projectId, topicId ]
          - format: pubsub:publish
      - httpMethod: POST
        relativePaths:
        - /v1alpha/subscriptions/:subscriptionId/pull
        - /v1alpha/subscriptions/:subscriptionId/ack
        - /v1alpha/subscriptions/:subscriptionId/nack
        params:
          - name: topicId
            source: header
            expr: Host
            function: firstLabel
          - name: projectId
            source: claim
            expr: acme/project/project\.id
          - name: sub
            source: claim
            expr: sub
          - name: subscriptionId
            source: path
        rules:
          - format: iam::%s:sa/%s
            paramNames: [ projectId, sub ]
          - format: pubsub:eu-central-1:%s:topics/%s/subscriptions/%s
            paramNames: [ projectId, topicId, subscriptionId ]
          - format: pubsub:read
